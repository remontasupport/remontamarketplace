generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ContractorProfile {
  id                              String    @id @default(cuid())
  zohoContactId                   String    @unique
  firstName                       String
  lastName                        String
  email                           String    @unique
  phone                           String?
  gender                          String?
  city                            String?
  state                           String?
  postalZipCode                   String?
  latitude                        Float?
  longitude                       Float?
  titleRole                       String?
  yearsOfExperience               Int?
  aboutYou                        String?
  qualificationsAndCertifications String?
  languageSpoken                  String?
  hasVehicleAccess                Boolean?
  funFact                         String?
  hobbiesAndInterests             String?
  whatMakesBusinessUnique         String?
  additionalInformation           String?
  profilePicture                  String?
  lastSyncedAt                    DateTime  @default(now())
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime  @updatedAt
  deletedAt                       DateTime?

  @@index([email])
  @@index([zohoContactId])
  @@index([deletedAt])
  @@index([city])
  @@index([state])
  @@index([postalZipCode])
  @@index([latitude, longitude])
  @@index([gender])
  @@index([titleRole])
  @@index([deletedAt, city])
  @@index([deletedAt, state])
  @@index([deletedAt, gender])
  @@index([deletedAt, titleRole])
  @@index([deletedAt, latitude, longitude])
}

model ContractorsbyArea {
  id          String   @id
  workerName  String
  suburbState String
  image       String?
  bio         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([suburbState])
}

model Job {
  id                        String    @id
  zohoId                    String    @unique
  dealName                  String
  title                     String?
  description               String?
  stage                     String
  suburbs                   String?
  state                     String?
  serviceAvailed            String?
  serviceRequirements       String?
  disabilities              String?
  behaviouralConcerns       String?
  culturalConsiderations    String?
  language                  String?
  religion                  String?
  age                       String?
  gender                    String?
  hobbies                   String?
  clientName                String?
  clientZohoId              String?
  relationshipToParticipant String?
  ownerName                 String?
  ownerEmail                String?
  ownerZohoId               String?
  postedAt                  DateTime?
  active                    Boolean   @default(true)
  requiredMoreWorker        Boolean?
  anotherContractorNeeded   Boolean?
  lastSyncedAt              DateTime  @default(now())
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime

  @@index([active])
  @@index([active, postedAt])
  @@index([active, serviceAvailed])
  @@index([active, stage])
  @@index([active, state])
  @@index([active, suburbs])
  @@index([lastSyncedAt])
  @@index([postedAt])
  @@index([serviceAvailed])
  @@index([stage])
  @@index([state])
  @@index([suburbs])
  @@index([zohoId])
}

// ============================================
// CATEGORIES & DOCUMENTS SYSTEM
// ============================================

// Stores all individual document definitions (e.g., "Police Check", "First Aid & CPR")
model Document {
  id            String   @id // e.g., "identity-points-100"
  name          String   // e.g., "100 Points of ID"
  category      String   // e.g., "IDENTITY", "BUSINESS", "COMPLIANCE"
  description   String   @db.Text
  hasExpiration Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  categoryDocuments      CategoryDocument[]
  subcategoryDocuments   SubcategoryDocument[]

  @@index([category])
}

// Stores main service categories (e.g., "Support Worker", "Therapeutic Supports")
model Category {
  id                    String   @id // e.g., "support-worker"
  name                  String   // e.g., "Support Worker"
  requiresQualification Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  subcategories         Subcategory[]
  documents             CategoryDocument[]
}

// Stores subcategories under a main category (e.g., "Personal care", "Art Therapist")
model Subcategory {
  id                   String   @id // e.g., "personal-care"
  categoryId           String
  name                 String   // e.g., "Personal care (showering, toileting...)"
  requiresRegistration String?  // e.g., "AHPRA" or null

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  category             Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  additionalDocuments  SubcategoryDocument[]

  @@index([categoryId])
}

// Join table linking categories to their required/optional/conditional documents
model CategoryDocument {
  id            String   @id @default(cuid())
  categoryId    String
  documentId    String

  documentType  String   // "REQUIRED" | "OPTIONAL" | "CONDITIONAL"

  // For conditional documents (e.g., transport docs required if providesTransport=true)
  conditionKey   String?  // e.g., "providesTransport"
  requiredIfTrue Boolean? // true if required when condition is true

  createdAt     DateTime @default(now())

  // Relations
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([categoryId, documentId, documentType, conditionKey])
  @@index([categoryId])
  @@index([documentId])
}

// Join table for subcategory-specific additional documents (e.g., AHPRA for OT)
model SubcategoryDocument {
  id            String      @id @default(cuid())
  subcategoryId String
  documentId    String

  createdAt     DateTime    @default(now())

  // Relations
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  document      Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([subcategoryId, documentId])
  @@index([subcategoryId])
  @@index([documentId])
}
